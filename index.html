<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0,user-scalable=no, minimum-sacle=1, maximum-scale=1"
    />
    <title>ç”Ÿæˆæ–‡å­—å›¾ç‰‡</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        --whiteShadow: -15px -15px 25px rgba(255, 255, 255, 0.6);
        --blackShadow: 15px 15px 25px rgba(110, 40, 40, 0.2);
      }
      body {
        width: 100vw;
        height: 100vh;
        padding-top: 20px;
        background: #ddd;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      header {
        font-size: 40px;
        font-weight: bold;
        margin-bottom: 10px;
        background-image: url(loading.gif);
        background-position: center;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      footer {
        width: 100%;
        height: 50px;
        line-height: 50px;
        text-align: center;
        position: sticky;
        bottom: 0;
        background: #999;
      }
      .btns {
        height: 50px;
        line-height: 50px;
      }
      .options .opt-content {
        position: relative;
      }
      .options .opt-content label {
        display: inline-block;
        min-width: 116px;
        text-align: right;
      }
      .preview {
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 300px;
        max-width: 96vw;
        min-height: 200px;
        border-radius: 5px;
        overflow: auto;
        margin-bottom: auto;
        box-shadow: inset var(--blackShadow), inset var(--whiteShadow);
      }
    </style>
  </head>
  <body>
    <header>æ–‡å­—è½¬å›¾ç‰‡</header>
    <div class="options">
      <div class="opt-content">
        <label for="text">æ–‡å­—å†…å®¹ï¼š</label>
        <input type="text" id="text" placeholder="è¯·è¾“å…¥æ–‡å­—å†…å®¹" />
      </div>
      <div class="opt-content">
        <label for="font">å­—ä½“ï¼š</label>
        <select name="font" id="font" onchange="selectFontChange()">
          <option value="Arial">Arial</option>
          <option value="monospace">monospace</option>
          <option value="cursive">cursive</option>
          <option value="CustomFont">ğŸ­è‡ªå®šä¹‰å­—ä½“</option>
        </select>
      </div>
      <div id="fontFileWrapper" class="opt-content" style="display: none">
        <label for="fontFile">ä¸Šä¼ å­—ä½“æ–‡ä»¶ï¼š</label>
        <input type="file" id="fontFile" />
      </div>
      <div class="opt-content">
        <label for="color">é¢œè‰²ï¼š</label>
        <select name="colorMode" id="colorMode" onchange="selectColorChange()">
          <option value="primary" selected>å•è‰²</option>
          <option value="gradient">æ¸å˜</option>
        </select>
        <input type="color" id="color" />
      </div>
      <div class="opt-content gradientColorWrapper" style="display: none">
        <label for="gradientStartColor">æ¸å˜å¼€å§‹è‰²ï¼š</label>
        <input type="color" id="gradientStartColor" />
      </div>
      <div class="opt-content gradientColorWrapper" style="display: none">
        <label for="gradientStartColor">æ¸å˜ç»“æŸè‰²ï¼š</label>
        <input type="color" id="gradientEndColor" />
      </div>
      <div class="opt-content gradientColorWrapper" style="display: none">
        <label for="gradientAngle">æ¸å˜è§’åº¦:</label>
        <input type="number" id="gradientAngle" min="0" max="360" value="180" />
      </div>
      <div class="opt-content">
        <label for="size">æ–‡å­—å¤§å°ï¼š</label>
        <input type="number" id="size" min="1" max="100" value="48" />
      </div>
      <div class="opt-content">
        <label for="weight">ç²—ç»†ï¼š</label>
        <input
          type="range"
          id="weight"
          min="100"
          max="900"
          step="100"
          value="400"
          list="datalist"
          onchange="weightChange()"
        /><span id="weightVal">400</span>
      </div>
      <div class="opt-content">
        <label for="imgWidth">å›¾ç‰‡å®½åº¦ï¼š</label>
        <input type="number" id="imgWidth" min="1" max="2048" value="400" />
      </div>
      <div class="opt-content">
        <label for="imgHeight">å›¾ç‰‡é«˜åº¦ï¼š</label>
        <input type="number" id="imgHeight" min="1" max="2048" value="200" />
      </div>
    </div>
    <div class="btns">
      <button onclick="generateImage()">ç”Ÿæˆå›¾ç‰‡</button>
      <a id="downloadLink" download="text_image.png" style="display: none">
        <button>ä¸‹è½½å›¾ç‰‡</button>
      </a>
    </div>
    <h2><img src="./text_yulan.png" alt="é¢„è§ˆ"></h2>
    <div class="preview">
      <canvas id="canvas"></canvas>
    </div>

    <footer>Copyright &copy; 2023 Xavier</footer>
    <script>
      // åŠ è½½å­—ä½“
      function loadFont(file) {
        let fontFile = URL.createObjectURL(file);
        let fontFace = new FontFace("CustomFont", "url(" + fontFile + ")");

        fontFace
          .load()
          .then(function (loadedFont) {
            document.fonts.add(loadedFont);
          })
          .catch(function (err) {
            alert("å­—ä½“åŠ è½½å¤±è´¥ï¼", err);
          });
      }
      // å­—ä½“ç²—ç»†å€¼æ”¹å˜
      function weightChange() {
        document.getElementById("weightVal").innerText =
          document.getElementById("weight").value;
      }
      function generateImage() {
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let text = document.getElementById("text").value; // æ–‡å­—å†…å®¹
        let font = document.getElementById("font").value; // å­—ä½“
        let color = document.getElementById("color").value; // æ–‡å­—é¢œè‰²
        let gradientStartColor =
          document.getElementById("gradientStartColor").value; // æ–‡å­—æ¸å˜å¼€å§‹è‰²
        let gradientEndColor =
          document.getElementById("gradientEndColor").value; // æ–‡å­—æ¸å˜ç»“æŸè‰²
        let gradientAngle = document.getElementById("gradientAngle").value; // æ–‡å­—æ¸å˜è‰²è§’åº¦
        let size = document.getElementById("size").value; // æ–‡å­—å¤§å°
        let weight = document.getElementById("weight").value; // æ–‡å­—ç²—ç»†
        let imgWidth = document.getElementById("imgWidth").value; // å›¾ç‰‡çš„å®½åº¦
        let imgHeight = document.getElementById("imgHeight").value; // å›¾ç‰‡é«˜åº¦

        if (!text.trim()) {
          alert("è¯·è¾“å…¥æ–‡å­—å†…å®¹");
          return;
        }
        canvas.width = parseInt(imgWidth);
        canvas.height = parseInt(imgHeight);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font =
          weight +
          " " +
          size +
          "px " +
          (fontFileInput.value ? "CustomFont" : font);

        if (document.getElementById("colorMode").value === "gradient") {
          // åˆ›å»ºæ¸å˜

          let angleInRadians = gradientAngle * (Math.PI / 180);
          let startPointX =
            canvas.width / 2 + (Math.cos(angleInRadians) * canvas.width) / 2;
          let startPointY =
            canvas.height / 2 + (Math.sin(angleInRadians) * canvas.height) / 2;
          let endPointX =
            canvas.width / 2 - (Math.cos(angleInRadians) * canvas.width) / 2;
          let endPointY =
            canvas.height / 2 - (Math.sin(angleInRadians) * canvas.height) / 2;
          let gradient = ctx.createLinearGradient(
            startPointX,
            startPointY,
            endPointX,
            endPointY
          );

          gradient.addColorStop(0, gradientStartColor);
          gradient.addColorStop(1, gradientEndColor);
          ctx.fillStyle = gradient;
        } else {
          ctx.fillStyle = color;
        }

        let textWidth = ctx.measureText(text).width;
        let x = (canvas.width - textWidth) / 2; // æ°´å¹³å±…ä¸­
        let y = canvas.height / 2 + parseInt(size) / 2; // å‚ç›´å±…ä¸­

        ctx.fillText(text, x, y);

        canvas.style.backgroundColor = "rgba(0,0,0,0)";

        let downloadLink = document.getElementById("downloadLink");
        let linkHref = canvas.toDataURL("image/png");
        downloadLink.href = linkHref;
        downloadLink.style.display = "inline-block";
      }

      let fontFileInput = document.getElementById("fontFile");
      fontFileInput.addEventListener("change", function (e) {
        let file = e.target.files[0];
        if (file) {
          loadFont(file);
        }
      });
      // å­—ä½“é€‰æ‹©å˜åŒ–
      function selectFontChange() {
        if (document.getElementById("font").value === "CustomFont") {
          document.getElementById("fontFileWrapper").style.display = "block";
        } else {
          document.getElementById("fontFileWrapper").style.display = "none";
        }
      }
      // å­—ä½“é¢œè‰²å˜åŒ–
      function selectColorChange() {
        if (document.getElementById("colorMode").value === "gradient") {
          document.getElementById("color").style.display = "none";
          document.querySelectorAll(".gradientColorWrapper").forEach(el => {
            el.style.display = "block";
          })
        } else {
          document.getElementById("color").style.display = "inline-block";
          document.querySelectorAll(".gradientColorWrapper").forEach(el => {
            el.style.display = "none";
          })
        }
      }
    </script>
  </body>
</html>
